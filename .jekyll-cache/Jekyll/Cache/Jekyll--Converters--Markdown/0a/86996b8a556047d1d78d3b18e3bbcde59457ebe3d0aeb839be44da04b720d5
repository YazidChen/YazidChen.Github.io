I"°<h1 id="websocket-sockjs-stomp">WebSocket SockJS STOMP</h1>

<h2 id="ä¸€ä¸ºä½•å¼•å…¥websocket">ä¸€ã€ä¸ºä½•å¼•å…¥WebSocket</h2>

<h3 id="11-é‡åˆ°é—®é¢˜">1.1 é‡åˆ°é—®é¢˜</h3>
<p>å½“å‰æœ‰ä¸€å®¢æœç®¡ç†ç³»ç»Ÿï¼Œæœ‰ä»¥ä¸‹ä¸šåŠ¡éœ€æ±‚ï¼š</p>

<h4 id="1å‘¼å‡ºä¸šåŠ¡">1ã€å‘¼å‡ºä¸šåŠ¡</h4>

<p><img src="https://yazid-public.oss-cn-shenzhen.aliyuncs.com/blog/images/20180129154827.png?x-oss-process=style/Watermark" alt="" /></p>

<p>å®¢æœç®¡ç†ç³»ç»Ÿå‘ç¬¬ä¸‰æ–¹äº‘å‘¼ç³»ç»Ÿå‘å‡ºå‘¼å«è¯·æ±‚ï¼Œäº‘å‘¼ç³»ç»Ÿå¼‚æ­¥è¿”å›å‘¼å‡ºå›è°ƒï¼Œåå°æœåŠ¡æ¥æ”¶åˆ°å›è°ƒåï¼Œéœ€è¦é€šçŸ¥WEBç«¯æç¤ºç”¨æˆ·å‘¼å‡ºçš„ç»“æœï¼Œæ­¤æ—¶æœ‰åå°æœåŠ¡ä¸»åŠ¨é€šçŸ¥WEBçš„éœ€æ±‚ã€‚</p>

<h4 id="2å‘¼å…¥ä¸šåŠ¡">2ã€å‘¼å…¥ä¸šåŠ¡</h4>

<p><img src="https://yazid-public.oss-cn-shenzhen.aliyuncs.com/blog/images/20180129154843.png?x-oss-process=style/Watermark" alt="" /></p>

<p>å½“æœ‰ç”µè¯å‘¼å…¥æ—¶ï¼Œäº‘å‘¼ç³»ç»Ÿå‘èµ·å‘¼å…¥é€šçŸ¥ç»™å®¢æœç®¡ç†ç³»ç»Ÿï¼Œå®¢æœç®¡ç†ç³»ç»Ÿåå°æœåŠ¡æ¥æ”¶åˆ°å‘¼å…¥é€šçŸ¥åï¼Œéœ€è¦åŠæ—¶è®©WEBå‘èµ·ç•Œé¢æé†’ï¼Œæ­¤æ—¶ä¹Ÿæœ‰åå°æœåŠ¡ä¸»åŠ¨é€šçŸ¥WEBçš„éœ€æ±‚ã€‚</p>

<h3 id="12-è§£å†³æ–¹æ¡ˆ">1.2 è§£å†³æ–¹æ¡ˆ</h3>

<ol>
  <li>WEBé€šè¿‡HTTPè½®è¯¢åå°æœåŠ¡ï¼ˆä¸æ»¡è¶³åŠæ—¶æ€§ï¼Œæ¶ˆè€—èµ„æºå¤§ï¼‰;</li>
  <li>HTTPé•¿è½®è¯¢(åŸºæœ¬æ»¡è¶³åŠæ—¶æ€§ï¼Œæ¶ˆè€—èµ„æºè¾ƒå¤§ï¼‰</li>
  <li>WebSocket(æ»¡è¶³åŠæ—¶æ€§ï¼Œæ¶ˆè€—èµ„æºå°ï¼Œæä¾›åŒå‘é€šä¿¡)ã€‚</li>
</ol>

<p>åˆæ­¥åˆ¤æ–­ï¼ŒWebSocketå¯ä»¥ä½œä¸ºè§£å†³æ–¹æ¡ˆã€‚ä¸‹é¢å¼€å§‹æ·±å…¥ç ”ç©¶WebSocketã€‚</p>

<h2 id="äºŒwebsocketæ˜¯ä»€ä¹ˆ">äºŒã€WebSocketæ˜¯ä»€ä¹ˆ</h2>

<p><strong>WebSocketåè®®</strong>ç”±HTML5å®šä¹‰ï¼Œèƒ½æ›´å¥½çš„<strong>èŠ‚çœ</strong>æœåŠ¡å™¨èµ„æºå’Œå¸¦å®½ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ›´å®æ—¶åœ°è¿›è¡Œ<strong>åŒå‘</strong>é€šè®¯ã€‚å®ƒæ˜¯ä¸€ç§æŒä¹…åŒ–çš„åè®®ã€‚
æˆ‘ä»¬æ‹¿WebSocketä¸HTTPè¿›è¡Œå¯¹æ¯”ã€‚</p>

<p><img src="https://yazid-public.oss-cn-shenzhen.aliyuncs.com/blog/images/20180130171453.png?x-oss-process=style/Watermark" alt="" /></p>

<p>é¦–å…ˆæ˜¯HTTPè½®è¯¢ï¼Œæµè§ˆå™¨é€šè¿‡ajaxæ¯éš”å‡ ç§’å°±å‘æœåŠ¡å™¨å‘èµ·ä¸€æ¬¡è¯·æ±‚ï¼Œè¯¢é—®æœåŠ¡å™¨æ˜¯å¦æœ‰æ–°çš„æ¶ˆæ¯ã€‚æ¯æ¬¡å‘èµ·çš„è¯·æ±‚ï¼Œå³Requestï¼Œå®ƒéƒ½åŒ…å«headerå¤´éƒ¨ï¼Œå¤šæ¬¡è½®è¯¢ç›¸å½“äºå¤šæ¬¡å‘é€äº†headerå¤´éƒ¨ä¿¡æ¯ï¼Œè¿™ä¾¿ä¼šé€ æˆå¸¦å®½èµ„æºçš„æµªè´¹ã€‚æ¯æ¬¡è¿”å›çš„Responseäº¦æ˜¯å¦‚æ­¤ã€‚</p>

<p>å…¶æ¬¡æ˜¯HTTPé•¿è½®è¯¢ï¼Œä¸å‰è€…ç›¸æ¯”ï¼Œé•¿è½®è¯¢é‡‡ç”¨çš„æ˜¯é˜»å¡æ¨¡å¼ï¼Œå³å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œä¼šä¸€ç›´ç­‰å¾…æœåŠ¡ç«¯æœ‰æ¶ˆæ¯åæ‰è¿”å›ï¼Œè€Œåå†æ¬¡å‘èµ·è¯·æ±‚ã€‚å¦‚æœæ— æ¶ˆæ¯ï¼Œå°±ä¼šä¸€ç›´ç­‰ï¼Œç›´è‡³è¶…æ—¶ã€‚</p>

<p>ä»¥ä¸Šä¸¤ç§æ–¹å¼ï¼Œéƒ½æ˜¯å®¢æˆ·ç«¯ä¸»åŠ¨å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚ï¼Œç­‰å¾…æœåŠ¡ç«¯å¤„ç†ã€‚è€ŒæœåŠ¡ç«¯ä¸èƒ½ä¸»åŠ¨è”ç³»å®¢æˆ·ç«¯ã€‚</p>

<p>ä¸‹é¢å¼€å§‹WebSocketåè®®å†…å®¹ï¼š
é¦–å…ˆï¼Œå®¢æˆ·ç«¯ä¼šå‘æœåŠ¡ç«¯å‘èµ·ä¸€æ¬¡Handshakeæ¡æ‰‹çš„è¯·æ±‚ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚å¹¶ç¡®è®¤æ— è¯¯åï¼Œè¿”å›ç¡®è®¤é€šçŸ¥ã€‚è¿™ä¸¤æ­¥æ“ä½œè¿˜æ˜¯é€šè¿‡HTTPåè®®è¿›è¡Œé€šä¿¡çš„ã€‚ç¡®è®¤é€šçŸ¥è¿”å›æˆåŠŸåï¼Œé€šä¿¡åè®®ç”±HTTPåè®®å‡çº§ä¸ºWebSocketåè®®ã€‚ä¹‹åï¼ŒæœåŠ¡ç«¯å°±èƒ½ä¸»åŠ¨æ¨é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ï¼Œå½“ç„¶ï¼Œå®¢æˆ·ç«¯ä¹Ÿèƒ½ä¸»åŠ¨æ¨æ¶ˆæ¯ç»™æœåŠ¡ç«¯ã€‚çœŸçœŸæ­£æ­£å®ç°äº†åŒå‘é€šè®¯ã€‚å¦‚æœè¦å…³é—­é€šä¿¡é“¾æ¥ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç»™æœåŠ¡ç«¯å‘é€æ–­å¼€é“¾æ¥çš„è¯·æ±‚ï¼Œå½“ç„¶ï¼ŒæœåŠ¡ç«¯ä¹Ÿå¯ä»¥ä¸»åŠ¨æ–­å¼€é“¾æ¥ã€‚è¿™æ ·ï¼Œæ•´ä¸ªé€šä¿¡é“¾æ¥çš„ç”Ÿå‘½å‘¨æœŸä¹Ÿå°±ç»“æŸäº†ã€‚
ç”±æ­¤çœ‹æ¥ï¼ŒWebSocketåªéœ€è¦ä¸€æ¬¡HTTPè¯·æ±‚è¿›è¡Œå»ºç«‹é“¾æ¥ï¼Œä¹‹åæ‰€æœ‰çš„é€šä¿¡éƒ½ä¸éœ€è¦æœ‰å¤æ‚çš„headerå¤´éƒ¨ä¿¡æ¯ï¼Œä¹Ÿæ— éœ€å¤šæ¬¡é‰´æƒäº†ï¼Œä»è€Œçœä¸‹äº†å¾ˆå¤šèµ„æºã€‚</p>

<p><img src="https://yazid-public.oss-cn-shenzhen.aliyuncs.com/blog/images/20180131094724.png?x-oss-process=style/Watermark" alt="" /></p>

<p>ç»§ç»­æ·±å…¥å­¦ä¹ WebSocketï¼Œæˆ‘ä»¬å‘ç°ä»–åŒHTTPåè®®ä¸€æ ·ï¼Œä¹Ÿæ˜¯å±äºOSIæ¨¡å‹çš„åº”ç”¨å±‚ï¼Œä¹Ÿæ˜¯å»ºç«‹åœ¨TCPåè®®ä¹‹ä¸Šçš„ã€‚WebSocketåè®®çš„<strong>ç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦</strong>æ˜¯<code class="highlighter-rouge">ws</code>ï¼Œå¦‚æœåŠ å¯†ï¼Œåˆ™æ˜¯<code class="highlighter-rouge">wss</code>,è¿™å’ŒHTTPå¦‚å‡ºä¸€è¾™ï¼Œéƒ½æ˜¯ç”±TSLè¿›è¡ŒåŠ å¯†çš„ã€‚</p>

<p><img src="https://yazid-public.oss-cn-shenzhen.aliyuncs.com/blog/images/20180131095930.png?x-oss-process=style/Watermark" alt="" /></p>

<p>æœåŠ¡å™¨çš„ç½‘å€ï¼Œå³ä¸ºURLï¼š<code class="highlighter-rouge">ws://example.com:80/test</code></p>

<h2 id="ä¸‰springmvcå¦‚ä½•å¼•å…¥websocket">ä¸‰ã€SpringMVCå¦‚ä½•å¼•å…¥WebSocket</h2>

<p>è¿™é‡Œæœ‰ä¸‰ç§APIï¼Œåˆ†åˆ«æ˜¯<code class="highlighter-rouge">WebSocket API</code>ï¼Œ<code class="highlighter-rouge">SockJS</code>ä»¥åŠ<code class="highlighter-rouge">STOMP</code>ã€‚<code class="highlighter-rouge">WebSocket API</code>æ˜¯å‘é€å’Œæ¥æ”¶æ¶ˆæ¯çš„åº•å±‚APIï¼Œ<code class="highlighter-rouge">SockJS</code>åœ¨<code class="highlighter-rouge">WebSocket API</code>ä¹‹ä¸Šï¼Œè€Œ<code class="highlighter-rouge">STOMP</code>æ˜¯åŸºäº<code class="highlighter-rouge">SockJS</code>çš„é«˜çº§APIã€‚</p>

<h3 id="31-websocket-api">3.1 WebSocket API</h3>

<h4 id="311-æœåŠ¡ç«¯é…ç½®">3.1.1 æœåŠ¡ç«¯é…ç½®</h4>

<p>1ã€åˆ›å»ºHandler</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.TextMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.WebSocketSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.handler.AbstractWebSocketHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span>

<span class="cm">/**
 * @author YazidChen
 * @date 2017/12/21 0021 11:10
 **/</span>
<span class="nd">@Service</span><span class="c1">//æ­¤å¤„æ³¨è§£æ‰«æ</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WsHandler</span> <span class="kd">extends</span> <span class="nc">AbstractWebSocketHandler</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleTextMessage</span><span class="o">(</span><span class="nc">WebSocketSession</span> <span class="n">session</span><span class="o">,</span> <span class="nc">TextMessage</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"into handleText"</span><span class="o">);</span>
        <span class="n">session</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="k">new</span> <span class="nc">TextMessage</span><span class="o">(</span><span class="s">"æ¥è‡ªæœåŠ¡å™¨çš„æ¶ˆæ¯ï¼"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>2ã€åˆ›å»ºæ¡æ‰‹æ‹¦æˆªå™¨ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">form</span><span class="o">.</span><span class="na">UserSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">ShiroUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.server.ServerHttpRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.server.ServerHttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.WebSocketHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.server.HandshakeInterceptor</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
 * @author YazidChen
 * @date 2017/12/21 0021 11:21
 **/</span>
<span class="nd">@Service</span><span class="c1">//æ­¤å¤„æ³¨è§£æ‰«æ</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WsHandshakeInterceptor</span> <span class="kd">implements</span> <span class="nc">HandshakeInterceptor</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">beforeHandshake</span><span class="o">(</span><span class="nc">ServerHttpRequest</span> <span class="n">serverHttpRequest</span><span class="o">,</span> <span class="nc">ServerHttpResponse</span> <span class="n">serverHttpResponse</span><span class="o">,</span> <span class="nc">WebSocketHandler</span> <span class="n">webSocketHandler</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
	<span class="c1">//åœ¨å¼•å…¥Shiroçš„æƒ…å†µä¸‹ï¼Œæ­¤å¤„å¯è·å–ç”¨æˆ·Session</span>
        <span class="nc">UserSession</span> <span class="n">userSession</span> <span class="o">=</span> <span class="nc">ShiroUtils</span><span class="o">.</span><span class="na">getUserSession</span><span class="o">();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"userSession"</span><span class="o">,</span> <span class="n">userSession</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterHandshake</span><span class="o">(</span><span class="nc">ServerHttpRequest</span> <span class="n">serverHttpRequest</span><span class="o">,</span> <span class="nc">ServerHttpResponse</span> <span class="n">serverHttpResponse</span><span class="o">,</span> <span class="nc">WebSocketHandler</span> <span class="n">webSocketHandler</span><span class="o">,</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>3ã€å°†WsHandlerç»‘å®šåˆ°ç‰¹å®šçš„URLä¸Š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">websocket</span><span class="o">.</span><span class="na">handler</span><span class="o">.</span><span class="na">WsHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">websocket</span><span class="o">.</span><span class="na">interceptor</span><span class="o">.</span><span class="na">WsHandshakeInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.config.annotation.EnableWebSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.config.annotation.WebSocketConfigurer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.config.annotation.WebSocketHandlerRegistry</span><span class="o">;</span>

<span class="cm">/**
 * @author YazidChen
 * @date 2018/01/31 0031 10:26
 **/</span>
<span class="nd">@Configuration</span>
<span class="nd">@EnableWebSocket</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WsConfig</span> <span class="kd">implements</span> <span class="nc">WebSocketConfigurer</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">WsHandler</span> <span class="n">wsHandler</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">WsHandshakeInterceptor</span> <span class="n">wsHandshakeInterceptor</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerWebSocketHandlers</span><span class="o">(</span><span class="nc">WebSocketHandlerRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">addHandler</span><span class="o">(</span><span class="n">wsHandler</span><span class="o">,</span> <span class="s">"/chat"</span><span class="o">).</span><span class="na">setAllowedOrigins</span><span class="o">(</span><span class="s">"https://www.xxx.com"</span><span class="o">).</span><span class="na">addInterceptors</span><span class="o">(</span><span class="n">wsHandshakeInterceptor</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">addHandler()</code>å°†<code class="highlighter-rouge">WsHandler</code>ç»‘å®šåœ¨äº†<code class="highlighter-rouge">/chat</code>è·¯å¾„ä¸Šï¼›</li>
  <li><code class="highlighter-rouge">setAllowedOrigins()</code>å…è®¸æ¥æºä¸º<code class="highlighter-rouge">https://www.xxx.com</code>çš„è¯·æ±‚ï¼Œè®¾ç½®ä¸º<code class="highlighter-rouge">*</code>å…è®¸æ‰€æœ‰æ¥æºï¼›</li>
  <li><code class="highlighter-rouge">addInterceptors()</code>æ·»åŠ æ‹¦æˆªå™¨ã€‚</li>
</ul>

<h4 id="312-å®¢æˆ·ç«¯é…ç½®">3.1.2 å®¢æˆ·ç«¯é…ç½®</h4>

<p>å®¢æˆ·ç«¯å‘èµ·WebSocketé“¾æ¥è¯·æ±‚ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="dl">"</span><span class="s2">wss://www.xxx.com/chat</span><span class="dl">"</span><span class="p">);</span><span class="c1">//å‘èµ·è¿æ¥</span>
            <span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">WebSocket open now!</span><span class="dl">"</span><span class="p">)</span>
                <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">message test!</span><span class="dl">"</span><span class="p">);</span><span class="c1">//å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯</span>
            <span class="p">};</span>

            <span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">WebSocket message now!</span><span class="dl">"</span><span class="p">);</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
            <span class="p">};</span>

            <span class="nx">ws</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">WebSocket close now!</span><span class="dl">"</span><span class="p">);</span>
            <span class="p">};</span>
</code></pre></div></div>

<h4 id="313-è¿è¡Œç»“æœ">3.1.3 è¿è¡Œç»“æœ</h4>

<p><img src="https://yazid-public.oss-cn-shenzhen.aliyuncs.com/blog/images/20180131150456.png?x-oss-process=style/Watermark" alt="" /></p>

<p><img src="https://yazid-public.oss-cn-shenzhen.aliyuncs.com/blog/images/20180131150249.png?x-oss-process=style/Watermark" alt="" /></p>

<ul>
  <li><code class="highlighter-rouge">Connection</code>ä¸ºUpgradeï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯å¸Œæœ›è¿æ¥å‡çº§ï¼›</li>
  <li><code class="highlighter-rouge">Upgrade</code>ä¸ºWebsocketï¼Œè¡¨ç¤ºå¸Œæœ›å‡çº§åˆ°Websocketåè®®ï¼›</li>
  <li><code class="highlighter-rouge">Sec-WebSocket-Key</code>æ˜¯éšæœºçš„å­—ç¬¦ä¸²ï¼ŒæœåŠ¡å™¨ç«¯ä¼šç”¨è¿™äº›æ•°æ®æ¥æ„é€ å‡ºä¸€ä¸ªSHA-1çš„ä¿¡æ¯æ‘˜è¦ã€‚æŠŠ<code class="highlighter-rouge">Sec-WebSocket-Key</code>åŠ ä¸Šä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ä¸²ï¼Œç„¶åè®¡ç®—<code class="highlighter-rouge">SHA-1</code>æ‘˜è¦ï¼Œä¹‹åè¿›è¡Œ<code class="highlighter-rouge">BASE-64</code>ç¼–ç ï¼Œå°†ç»“æœä½œä¸º<code class="highlighter-rouge">Sec-WebSocket-Accept</code>å¤´çš„å€¼ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å¦‚æ­¤æ“ä½œï¼Œå¯ä»¥å°½é‡é¿å…æ™®é€š<code class="highlighter-rouge">HTTP</code>è¯·æ±‚è¢«è¯¯è®¤ä¸º<code class="highlighter-rouge">Websocket</code>åè®®ï¼›</li>
  <li><code class="highlighter-rouge">Sec-WebSocket-Version</code>è¡¨ç¤ºæ”¯æŒçš„Websocketç‰ˆæœ¬ï¼›</li>
  <li>Websocketé€šè¿‡<code class="highlighter-rouge">HTTP/1.1</code>åè®®çš„<code class="highlighter-rouge">101</code>çŠ¶æ€ç è¿›è¡Œæ¡æ‰‹ï¼Œæ­¤æ—¶æ¡æ‰‹æˆåŠŸã€‚</li>
</ul>

<h3 id="32-sockjs">3.2 SockJS</h3>

<p>åœ¨<code class="highlighter-rouge">WebSocket API</code>çš„åŸºç¡€ä¸Šï¼Œç¨åŠ ä¿®æ”¹ï¼Œå°±å˜ä¸º<code class="highlighter-rouge">SockJS</code>å½¢å¼ã€‚</p>

<h4 id="321-æœåŠ¡ç«¯é…ç½®">3.2.1 æœåŠ¡ç«¯é…ç½®</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">websocket</span><span class="o">.</span><span class="na">handler</span><span class="o">.</span><span class="na">WsHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">websocket</span><span class="o">.</span><span class="na">interceptor</span><span class="o">.</span><span class="na">WsHandshakeInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.config.annotation.EnableWebSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.config.annotation.WebSocketConfigurer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.config.annotation.WebSocketHandlerRegistry</span><span class="o">;</span>

<span class="cm">/**
 * @author YazidChen
 * @date 2018/01/31 0031 10:26
 **/</span>
<span class="nd">@Configuration</span>
<span class="nd">@EnableWebSocket</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WsConfig</span> <span class="kd">implements</span> <span class="nc">WebSocketConfigurer</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">WsHandler</span> <span class="n">wsHandler</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">WsHandshakeInterceptor</span> <span class="n">wsHandshakeInterceptor</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerWebSocketHandlers</span><span class="o">(</span><span class="nc">WebSocketHandlerRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">addHandler</span><span class="o">(</span><span class="n">wsHandler</span><span class="o">,</span> <span class="s">"/chat"</span><span class="o">).</span><span class="na">setAllowedOrigins</span><span class="o">(</span><span class="s">"https://www.xxx.com"</span><span class="o">).</span><span class="na">addInterceptors</span><span class="o">(</span><span class="n">wsHandshakeInterceptor</span><span class="o">).</span><span class="na">withSockJS</span><span class="o">();</span><span class="c1">//æ­¤å¤„ä½¿ç”¨SockJS</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ–¹æ³•<code class="highlighter-rouge">withSockJS()</code>ç”¨SockJSæ”¹é€ äº†åŸå§‹çš„API</p>

<h4 id="322-å®¢æˆ·ç«¯é…ç½®">3.2.2 å®¢æˆ·ç«¯é…ç½®</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--</span><span class="err">å¼•å…¥</span><span class="nx">sockjs</span><span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">text/javascript</span><span class="dl">"</span> <span class="nx">src</span><span class="o">=</span><span class="dl">"</span><span class="s2">/statics/libs/sockjs.min.js</span><span class="dl">"</span><span class="o">&gt;&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span><span class="c">&lt;!--</span><span class="err">æ­¤å¤„ä¸º</span><span class="nx">https</span><span class="err">åè®®</span><span class="o">--&gt;</span>
            <span class="kd">let</span> <span class="nx">sock</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SockJS</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.xxx.com/chat</span><span class="dl">"</span><span class="p">);</span>
            <span class="nx">sock</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">WebSocket open now!</span><span class="dl">"</span><span class="p">)</span>
                <span class="nx">sock</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">message test!</span><span class="dl">"</span><span class="p">);</span><span class="c1">//å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯</span>
            <span class="p">};</span>

            <span class="nx">sock</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">WebSocket message now!</span><span class="dl">"</span><span class="p">);</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
            <span class="p">};</span>

            <span class="nx">sock</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">WebSocket close now!</span><span class="dl">"</span><span class="p">);</span>
            <span class="p">};</span>
</code></pre></div></div>

<p><strong>SockJS</strong>å°†<code class="highlighter-rouge">http</code>æˆ–<code class="highlighter-rouge">https</code>åè®®å¤„ç†æˆä¸º<code class="highlighter-rouge">ws</code>æˆ–<code class="highlighter-rouge">wss</code>åè®®ã€‚</p>

<h4 id="323-è¿è¡Œç»“æœ">3.2.3 è¿è¡Œç»“æœ</h4>

<p><img src="https://yazid-public.oss-cn-shenzhen.aliyuncs.com/blog/images/20180131155239.png?x-oss-process=style/Watermark" alt="" /></p>

<p><img src="https://yazid-public.oss-cn-shenzhen.aliyuncs.com/blog/images/20180131155113.png?x-oss-process=style/Watermark" alt="" /></p>

<h3 id="33-stomp">3.3 STOMP</h3>

<p>æ­¤å¤„ä¸ºXMLé…ç½®å½¢å¼ç¤ºä¾‹ã€‚</p>

<h4 id="331-æœåŠ¡ç«¯é…ç½®">3.3.1 æœåŠ¡ç«¯é…ç½®</h4>

<p>1ã€åˆ›å»ºæ‹¦æˆªå™¨ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">form</span><span class="o">.</span><span class="na">UserSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">ShiroUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.server.ServerHttpRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.server.ServerHttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.WebSocketHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.server.HandshakeInterceptor</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
 * @author YazidChen
 * @date 2017/12/21 0021 11:21
 **/</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WsHandshakeInterceptor</span> <span class="kd">implements</span> <span class="nc">HandshakeInterceptor</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">beforeHandshake</span><span class="o">(</span><span class="nc">ServerHttpRequest</span> <span class="n">serverHttpRequest</span><span class="o">,</span> <span class="nc">ServerHttpResponse</span> <span class="n">serverHttpResponse</span><span class="o">,</span> <span class="nc">WebSocketHandler</span> <span class="n">webSocketHandler</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">UserSession</span> <span class="n">userSession</span> <span class="o">=</span> <span class="nc">ShiroUtils</span><span class="o">.</span><span class="na">getUserSession</span><span class="o">();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"userSession"</span><span class="o">,</span> <span class="n">userSession</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterHandshake</span><span class="o">(</span><span class="nc">ServerHttpRequest</span> <span class="n">serverHttpRequest</span><span class="o">,</span> <span class="nc">ServerHttpResponse</span> <span class="n">serverHttpResponse</span><span class="o">,</span> <span class="nc">WebSocketHandler</span> <span class="n">webSocketHandler</span><span class="o">,</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>2ã€XMLé…ç½®ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c">&lt;!--åˆ©ç”¨fastjsonæ”¹å˜æ¶ˆæ¯ä½“ä¼ è¾“æ–¹å¼--&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"fastjsonSockJsMessageCodec"</span> <span class="na">class=</span><span class="s">"com.alibaba.fastjson.support.spring.FastjsonSockJsMessageCodec"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!--å¼€å¯websocket--&gt;</span>
    <span class="nt">&lt;websocket:message-broker</span> <span class="na">application-destination-prefix=</span><span class="s">"/ws"</span> <span class="na">user-destination-prefix=</span><span class="s">"/user"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;websocket:stomp-endpoint</span> <span class="na">path=</span><span class="s">"/portfolio"</span> <span class="na">allowed-origins=</span><span class="s">"*"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;websocket:handshake-interceptors&gt;</span>
                <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"wsHandshakeInterceptor"</span>
                      <span class="na">class=</span><span class="s">"com.*.websocket.interceptor.WsHandshakeInterceptor"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/websocket:handshake-interceptors&gt;</span>
            <span class="nt">&lt;websocket:sockjs</span> <span class="na">message-codec=</span><span class="s">"fastjsonSockJsMessageCodec"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/websocket:stomp-endpoint&gt;</span>
        <span class="nt">&lt;websocket:simple-broker</span> <span class="na">prefix=</span><span class="s">"/topic, /queue"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/websocket:message-broker&gt;</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">stomp-endpoint</code>ä¸­ï¼Œ<code class="highlighter-rouge">path</code>ä¸º<code class="highlighter-rouge">/portfolio</code>æ˜¯å®¢æˆ·ç«¯éœ€è¦è¿æ¥åˆ°WebSocketæ¡æ‰‹çš„ç«¯ç‚¹çš„HTTP URLï¼›</li>
  <li><code class="highlighter-rouge">stomp-endpoint</code>ä¸­ï¼Œ<code class="highlighter-rouge">allowed-origins</code>ä¸º<code class="highlighter-rouge">*</code>å…è®¸æ‰€æœ‰æ¥æºï¼›</li>
  <li><code class="highlighter-rouge">message-broker</code>ä¸­ï¼Œ<code class="highlighter-rouge">application-destination-prefix</code>çš„<code class="highlighter-rouge">/ws</code>å°†STOMPæ¶ˆæ¯è·¯ç”±åˆ°ç±»ä¸­çš„@MessageMappingæ³¨è§£çš„æ–¹æ³•ï¼›</li>
  <li><code class="highlighter-rouge">message-broker</code>ä¸­ï¼Œ<code class="highlighter-rouge">user-destination-prefix="/user"</code>è¡¨ç¤ºå¼€å¯ç”¨æˆ·ç›®çš„åœ°ï¼ŒæœåŠ¡å™¨å¯ä»¥å‘é€é’ˆå¯¹ç‰¹å®šç”¨æˆ·çš„æ¶ˆæ¯ï¼Œå¹¶ä¸”Springçš„STOMPå¯ä»¥è¯†åˆ«â€/user/â€ä»¥æ­¤ä¸ºå‰ç¼€çš„ç›®æ ‡ï¼›</li>
  <li><code class="highlighter-rouge">simple-broker</code>ä¸­ï¼Œ<code class="highlighter-rouge">prefix="/topic, /queue"</code>è¡¨ç¤ºä»£ç†ç›®çš„åœ°å‰ç¼€ï¼Œå³è®¢é˜…æ—¶çš„å‰ç¼€ã€‚</li>
</ul>

<p>3ã€å¯¹äºç”¨æˆ·ç›®çš„åœ°ï¼Œç¼–å†™ä¸€ä¸ªç”¨æˆ·ç®¡ç†ä¸­å¿ƒï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">callcenter</span><span class="o">.</span><span class="na">form</span><span class="o">.</span><span class="na">WsMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.simp.SimpMessagingTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
 * @author YazidChen
 * @date 2018/01/23 0023 12:45
 **/</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WsUsers</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">users</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">SimpMessagingTemplate</span> <span class="n">template</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å‘é€æ¶ˆæ¯ç»™è®¢é˜…è€…
     *
     * @param subscribePath è®¢é˜…è·¯å¾„
     * @param userId        å®¢æœID
     * @param wsMessage     æ¶ˆæ¯ä½“
     * @author YazidChen
     * @createDate 2018/01/23 0023 14:59
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendToUser</span><span class="o">(</span><span class="nc">String</span> <span class="n">subscribePath</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="nc">WsMessage</span> <span class="n">wsMessage</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">list</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">list</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">template</span><span class="o">);</span>
        <span class="n">list</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">username</span> <span class="o">-&gt;</span> <span class="n">template</span><span class="o">.</span><span class="na">convertAndSendToUser</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">subscribePath</span><span class="o">,</span> <span class="n">wsMessage</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>4ã€åˆ›å»ºç›‘å¬å™¨ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">UserSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">UserService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">StatusEnum</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">websocket</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">WsUsers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.Message</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.MessageHeaders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.messaging.SessionConnectedEvent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
 * @author YazidChen
 * @date 2018/01/23 0023 11:41
 **/</span>
<span class="nd">@Component</span><span class="c1">//æ³¨è§£æ‰«æ</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WsConnectedListen</span> <span class="kd">implements</span> <span class="nc">ApplicationListener</span><span class="o">&lt;</span><span class="nc">SessionConnectedEvent</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="nc">SessionConnectedEvent</span> <span class="n">sessionConnectedEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MessageHeaders</span> <span class="n">messageHeader</span> <span class="o">=</span> <span class="n">sessionConnectedEvent</span><span class="o">.</span><span class="na">getMessage</span><span class="o">().</span><span class="na">getHeaders</span><span class="o">();</span>
        <span class="nc">Map</span> <span class="n">simpSessionAttributes</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">)</span> <span class="o">((</span><span class="nc">Message</span><span class="o">)</span> <span class="n">messageHeader</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"simpConnectMessage"</span><span class="o">)).</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"simpSessionAttributes"</span><span class="o">);</span>

        <span class="nc">UserSession</span> <span class="n">userSession</span> <span class="o">=</span> <span class="o">(</span><span class="nc">UserSession</span><span class="o">)</span> <span class="n">simpSessionAttributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"userSession"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">simpUser</span> <span class="o">=</span> <span class="n">messageHeader</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"simpUser"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
        <span class="c1">//å†…å­˜ä¸å­˜åœ¨å½“å‰ç”¨æˆ·ID</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">WsUsers</span><span class="o">.</span><span class="na">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userSession</span><span class="o">.</span><span class="na">getUserId</span><span class="o">())</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">simpUser</span><span class="o">);</span>
            <span class="nc">WsUsers</span><span class="o">.</span><span class="na">users</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">userSession</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span> <span class="n">list</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span><span class="c1">//å†…å­˜å­˜åœ¨å½“å‰ç”¨æˆ·ID</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="nc">WsUsers</span><span class="o">.</span><span class="na">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userSession</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
            <span class="c1">//æ ¡éªŒæ˜¯å¦ä¸åŒ…å«å½“å‰session</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">list</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">simpUser</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">simpUser</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//ç”¨æˆ·ä¸Šçº¿</span>
        <span class="n">userService</span><span class="o">.</span><span class="na">onOffLine</span><span class="o">(</span><span class="n">userSession</span><span class="o">,</span> <span class="nc">StatusEnum</span><span class="o">.</span><span class="na">ON_OFF_LINE</span><span class="o">.</span><span class="na">ON_LINE</span><span class="o">.</span><span class="na">type</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p><code class="highlighter-rouge">SessionConnectedEvent</code>äº‹ä»¶åœ¨STOMPè¿æ¥å®Œå…¨å»ºç«‹åå‘å¸ƒï¼Œæ­¤å¤„ç”¨äºå°†ç”¨æˆ·ä¸€è‡³å¤šä¸ªæµè§ˆå™¨çª—å£çš„sessionIdå­˜å…¥å†…å­˜ä¸­ã€‚ï¼ˆè€ƒè™‘åˆ°å®¢æœç³»ç»Ÿç”¨æˆ·é‡å°ï¼Œé€‰æ‹©å­˜å…¥å†…å­˜ã€‚ï¼‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">UserSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">UserService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">StatusEnum</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">websocket</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">WsUsers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.MessageHeaders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.socket.messaging.SessionDisconnectEvent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
 * @author YazidChen
 * @date 2018/01/23 0023 14:15
 **/</span>
<span class="nd">@Component</span><span class="c1">//æ³¨è§£æ‰«æ</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WsDisconnectListen</span> <span class="kd">implements</span> <span class="nc">ApplicationListener</span><span class="o">&lt;</span><span class="nc">SessionDisconnectEvent</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="nc">SessionDisconnectEvent</span> <span class="n">sessionDisconnectEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MessageHeaders</span> <span class="n">messageHeader</span> <span class="o">=</span> <span class="n">sessionDisconnectEvent</span><span class="o">.</span><span class="na">getMessage</span><span class="o">().</span><span class="na">getHeaders</span><span class="o">();</span>
        <span class="nc">UserSession</span> <span class="n">userSession</span> <span class="o">=</span> <span class="o">(</span><span class="nc">UserSession</span><span class="o">)</span> <span class="o">((</span><span class="nc">Map</span><span class="o">)</span> <span class="n">messageHeader</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"simpSessionAttributes"</span><span class="o">)).</span><span class="na">get</span><span class="o">(</span><span class="s">"userSession"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">simpUser</span> <span class="o">=</span> <span class="n">messageHeader</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"simpUser"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
        <span class="c1">//å¦‚æœå†…å­˜ä¸­å­˜åœ¨å½“å‰ç”¨æˆ·ID</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">WsUsers</span><span class="o">.</span><span class="na">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userSession</span><span class="o">.</span><span class="na">getUserId</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">List</span> <span class="n">list</span> <span class="o">=</span> <span class="nc">WsUsers</span><span class="o">.</span><span class="na">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userSession</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">simpUser</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">//åˆ é™¤ç”¨æˆ·å½“å‰æ–­å¼€çš„session</span>
                <span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">simpUser</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">WsUsers</span><span class="o">.</span><span class="na">users</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">userSession</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//ç”¨æˆ·ä¸‹çº¿</span>
        <span class="n">userService</span><span class="o">.</span><span class="na">onOffLine</span><span class="o">(</span><span class="n">userSession</span><span class="o">,</span> <span class="nc">StatusEnum</span><span class="o">.</span><span class="na">ON_OFF_LINE</span><span class="o">.</span><span class="na">OFF_LINE</span><span class="o">.</span><span class="na">type</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p><code class="highlighter-rouge">SessionDisconnectEvent</code>äº‹ä»¶å†STOMPè¿æ¥å®Œå…¨å…³é—­æ—¶å‘å¸ƒï¼Œæ­¤å¤„å°†ç”¨æˆ·sessionIdç§»å‡ºå†…å­˜ã€‚</p>

<p><code class="highlighter-rouge">web.xml</code>ä¸­é…ç½®ç›‘å¬å™¨åŒ…è·¯å¾„ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>...websocket.listen.WsConnectedListen<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>

    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>...listen.WsDisconnectListen<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
</code></pre></div></div>

<p>5ã€ç¼–å†™æµ‹è¯•Controller:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">UserSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">WsMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">WsUsers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.*</span><span class="o">.</span><span class="na">controller</span><span class="o">.</span><span class="na">AbstractController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.handler.annotation.MessageMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.simp.SimpMessageHeaderAccessor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.simp.SimpMessagingTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.simp.annotation.SendToUser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestParam</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseBody</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
 * @author YazidChen
 * @date 2017/12/22 0022 14:28
 **/</span>
<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WsController</span> <span class="kd">extends</span> <span class="nc">AbstractController</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">SimpMessagingTemplate</span> <span class="n">template</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">WsUsers</span> <span class="n">wsUsers</span><span class="o">;</span>

    <span class="nd">@MessageMapping</span><span class="o">(</span><span class="s">"trade"</span><span class="o">)</span>
    <span class="nd">@SendToUser</span><span class="o">(</span><span class="s">"/queue/sub"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="no">R</span> <span class="nf">wsTest</span><span class="o">(</span><span class="nc">SimpMessageHeaderAccessor</span> <span class="n">accessor</span><span class="o">,</span> <span class="nd">@RequestParam</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯ï¼"</span><span class="o">);</span>
        <span class="nc">UserSession</span> <span class="n">userSession</span> <span class="o">=</span> <span class="o">(</span><span class="nc">UserSession</span><span class="o">)</span> <span class="n">accessor</span><span class="o">.</span><span class="na">getSessionAttributes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"userSession"</span><span class="o">);</span>
        <span class="k">return</span> <span class="no">R</span><span class="o">.</span><span class="na">ok</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">"mess"</span><span class="o">,</span> <span class="s">"æœåŠ¡ç«¯è¿”å›æ¶ˆæ¯ï¼"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å‘é€ç”¨æˆ·æ¶ˆæ¯æµ‹è¯•æ¥å£
     *
     * @param userId        ç”¨æˆ·ID
     * @param subscribePath è®¢é˜…åœ°å€
     * @return
     * @author YazidChen
     * @createDate 2018/01/31 0031 16:05
     */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"sendMsToUser"</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="no">R</span> <span class="nf">sendMsToUser</span><span class="o">(</span><span class="kt">long</span> <span class="n">userId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">subscribePath</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"data"</span><span class="o">,</span> <span class="s">"The Data!"</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span> <span class="s">"The message!"</span><span class="o">);</span>

        <span class="nc">WsMessage</span> <span class="n">wsMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WsMessage</span><span class="o">();</span>
        <span class="n">wsMessage</span><span class="o">.</span><span class="na">setBusinessType</span><span class="o">(</span><span class="s">"TEST"</span><span class="o">);</span>
        <span class="n">wsMessage</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>

        <span class="n">wsUsers</span><span class="o">.</span><span class="na">sendToUser</span><span class="o">(</span><span class="n">subscribePath</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="n">wsMessage</span><span class="o">);</span>
        <span class="k">return</span> <span class="no">R</span><span class="o">.</span><span class="na">ok</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å‘é€å…¨å±€æ¶ˆæ¯æµ‹è¯•æ¥å£
     *
     * @param subscribePath è®¢é˜…åœ°å€
     * @return
     * @author YazidChen
     * @createDate 2018/01/31 0031 16:05
     */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"sendMsAll"</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="no">R</span> <span class="nf">sendMsAll</span><span class="o">(</span><span class="nc">String</span> <span class="n">subscribePath</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"data"</span><span class="o">,</span> <span class="s">"The All Data!"</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span> <span class="s">"The All message!"</span><span class="o">);</span>

        <span class="nc">WsMessage</span> <span class="n">wsMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WsMessage</span><span class="o">();</span>
        <span class="n">wsMessage</span><span class="o">.</span><span class="na">setBusinessType</span><span class="o">(</span><span class="s">"TEST All"</span><span class="o">);</span>
        <span class="n">wsMessage</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>

        <span class="n">template</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">subscribePath</span><span class="o">,</span> <span class="n">wsMessage</span><span class="o">);</span>
        <span class="k">return</span> <span class="no">R</span><span class="o">.</span><span class="na">ok</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="332-å®¢æˆ·ç«¯é…ç½®">3.3.2 å®¢æˆ·ç«¯é…ç½®</h4>

<p>éœ€è¦å¼•å…¥stomp.js:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">text/javascript</span><span class="dl">"</span> <span class="nx">src</span><span class="o">=</span><span class="dl">"</span><span class="s2">/statics/libs/stomp.min.js</span><span class="dl">"</span><span class="o">&gt;&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>
<span class="kd">let</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SockJS</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://www.xxx.com/portfolio</span><span class="dl">'</span><span class="p">);</span>
            <span class="kd">let</span> <span class="nx">stompClient</span> <span class="o">=</span> <span class="nx">Stomp</span><span class="p">.</span><span class="nx">over</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span>
            <span class="cm">/*            stompClient.debug = function (str) {
                            //ä¸è¾“å‡ºæ—¥å¿—åˆ°æ§åˆ¶å°
                        };*/</span>
            <span class="nx">stompClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">({},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">messageModel</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="nx">messageModel</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="nx">messageModel</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">jhbjhjashuj</span><span class="dl">"</span><span class="p">;</span>
                <span class="c1">//å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯</span>
                <span class="nx">stompClient</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">/ws/trade</span><span class="dl">"</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">messageModel</span><span class="p">));</span>
                <span class="c1">//ç”¨æˆ·è®¢é˜…</span>
                <span class="nx">stompClient</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/user/queue/sub</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">let</span> <span class="nx">wsMessage</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
                    <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">wsMessage</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
                <span class="p">});</span>
                <span class="c1">//å…¨å±€è®¢é˜…</span>
                <span class="nx">stompClient</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/topic/all</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">let</span> <span class="nx">wsMessage</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
                    <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">wsMessage</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="p">});</span>
</code></pre></div></div>

<h4 id="333-è¿è¡Œç»“æœ">3.3.3 è¿è¡Œç»“æœ</h4>

<p>1ã€è¿æ¥ç»“æœï¼š</p>

<p><img src="https://yazid-public.oss-cn-shenzhen.aliyuncs.com/blog/images/20180131163732.png?x-oss-process=style/Watermark" alt="" /></p>

<p>2ã€å‘é€å…¨å±€æ¶ˆæ¯ï¼š</p>

<p><img src="https://yazid-public.oss-cn-shenzhen.aliyuncs.com/blog/images/20180131163745.png?x-oss-process=style/Watermark" alt="" /></p>

<p>3ã€ç”¨æˆ·ç›®çš„åœ°æ¶ˆæ¯å‘é€ï¼š</p>

<p><img src="https://yazid-public.oss-cn-shenzhen.aliyuncs.com/blog/images/20180131163910.png?x-oss-process=style/Watermark" alt="" /></p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<p>æœ¬æ–‡å‚è€ƒä»¥ä¸‹æ–‡ç« ï¼Œåœ¨æ­¤å¯¹åŸä½œè€…è¡¨ç¤ºæ„Ÿè°¢ï¼</p>

<p><a href="https://docs.spring.io/spring/docs/5.0.3.RELEASE/spring-framework-reference/web.html#websocket">Spring.io WebSocket</a></p>

<p><a href="http://www.ruanyifeng.com/blog/2017/05/websocket.html">WebSocket æ•™ç¨‹</a></p>

<p><a href="https://zh.wikipedia.org/wiki/WebSocket">WebSocketç»´åŸºç™¾ç§‘</a></p>

<p><a href="https://www.zhihu.com/question/20215561">WebSocket æ˜¯ä»€ä¹ˆåŸç†ï¼Ÿä¸ºä»€ä¹ˆå¯ä»¥å®ç°æŒä¹…è¿æ¥ï¼Ÿ</a></p>

:ET