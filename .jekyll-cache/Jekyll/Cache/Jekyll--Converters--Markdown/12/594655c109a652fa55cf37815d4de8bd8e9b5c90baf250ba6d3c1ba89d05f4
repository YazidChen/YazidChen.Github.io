I"çJ<h1 id="nginx-security-for-ubuntu1604">Nginx Security For Ubuntu16.04</h1>

<h2 id="ä¸€éšè—ç‰ˆæœ¬å·">ä¸€ã€éšè—ç‰ˆæœ¬å·</h2>

<p><a href="http://www.freebuf.com/news/9026.html">nginxçˆ†æ•´æ•°æº¢å‡ºæ¼æ´</a>
ä¸æ€•ä¸€ä¸‡ï¼Œå°±æ€•ä¸‡ä¸€ã€‚</p>

<h3 id="11-åŸå§‹çŠ¶æ€">1.1 åŸå§‹çŠ¶æ€</h3>

<p>åŸå§‹æƒ…å†µä¸‹ï¼Œè®¿é—®é”™è¯¯çš„é“¾æ¥ä¼šæœ‰æš´éœ²ç‰ˆæœ¬ä¿¡æ¯çš„å±é™©ã€‚</p>

<p><img src="https://i.imgur.com/7NmzOaN.png" alt="" /></p>

<p>ç”¨curlå‘½ä»¤æŸ¥å‡ºåŸå§‹çš„ç‰ˆæœ¬ä¿¡æ¯ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-I</span> www.xxx.com
</code></pre></div></div>

<p><img src="https://i.imgur.com/GghodbU.png" alt="" /></p>

<h3 id="12-ä¿®æ”¹ngx_http_header_filter_modulecæ–‡ä»¶">1.2 ä¿®æ”¹ngx_http_header_filter_module.cæ–‡ä»¶</h3>

<p>è¿›å…¥nginxæºç ç›®å½•ï¼Œæ‰¾åˆ°<code class="highlighter-rouge">ngx_http_header_filter_module.c</code>æ–‡ä»¶è¿›è¡Œç¼–è¾‘,æ‰¾åˆ°ä»¥ä¸‹è¡Œï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static char ngx_http_server_string[] <span class="o">=</span> <span class="s2">"Server: nginx"</span> CRLF<span class="p">;</span>
</code></pre></div></div>

<p>å°†nginxä¿®æ”¹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static char ngx_http_server_string[] <span class="o">=</span> <span class="s2">"Server: Yazid"</span> CRLF<span class="p">;</span>
</code></pre></div></div>

<h3 id="13-ä¿®æ”¹ngx_http_special_responsecæ–‡ä»¶">1.3 ä¿®æ”¹ngx_http_special_response.cæ–‡ä»¶</h3>

<p>è¿›å…¥nginxæºç ç›®å½•ï¼Œæ‰¾åˆ°<code class="highlighter-rouge">ngx_http_special_response.c</code>æ–‡ä»¶è¿›è¡Œç¼–è¾‘,æ‰¾åˆ°ä»¥ä¸‹ä»£ç æ®µï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static u_char ngx_http_error_full_tail[] <span class="o">=</span>
<span class="s2">"&lt;hr&gt;&lt;center&gt;"</span> NGINX_VER <span class="s2">"&lt;/center&gt;"</span> CRLF
<span class="s2">"&lt;/body&gt;"</span> CRLF
<span class="s2">"&lt;/html&gt;"</span> CRLF
<span class="p">;</span>

static u_char ngx_http_error_tail[] <span class="o">=</span>
<span class="s2">"&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;"</span> CRLF
<span class="s2">"&lt;/body&gt;"</span> CRLF
<span class="s2">"&lt;/html&gt;"</span> CRLF
<span class="p">;</span>

</code></pre></div></div>

<p>å°†NGINX_VERå»é™¤ï¼Œå°†nginxä¿®æ”¹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static u_char ngx_http_error_full_tail[] <span class="o">=</span>
<span class="s2">"&lt;hr&gt;&lt;center&gt;""&lt;/center&gt;"</span> CRLF
<span class="s2">"&lt;/body&gt;"</span> CRLF
<span class="s2">"&lt;/html&gt;"</span> CRLF
<span class="p">;</span>

static u_char ngx_http_error_tail[] <span class="o">=</span>
<span class="s2">"&lt;hr&gt;&lt;center&gt;Yazid&lt;/center&gt;"</span> CRLF
<span class="s2">"&lt;/body&gt;"</span> CRLF
<span class="s2">"&lt;/html&gt;"</span> CRLF
<span class="p">;</span>

</code></pre></div></div>

<h3 id="14-ä¿®æ”¹nginxhæ–‡ä»¶">1.4 ä¿®æ”¹nginx.hæ–‡ä»¶</h3>

<p>è¿›å…¥nginxæºç ç›®å½•ï¼Œæ‰¾åˆ°<code class="highlighter-rouge">nginx.h</code>æ–‡ä»¶è¿›è¡Œç¼–è¾‘,æ‰¾åˆ°ä»¥ä¸‹ä»£ç æ®µï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#define nginx_version      1011004</span>
<span class="c">#define NGINX_VERSION      "1.11.4"</span>
<span class="c">#define NGINX_VER          "nginx/" NGINX_VERSION</span>
<span class="c">#define NGINX_VAR          "NGINX"</span>
</code></pre></div></div>

<p>å°†æ‰€æœ‰æ•æ„Ÿä¿¡æ¯ä¿®æ”¹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#define nginx_version      0</span>
<span class="c">#define NGINX_VERSION      "0"</span>
<span class="c">#define NGINX_VER          "Yazid/" NGINX_VERSION</span>
<span class="c">#define NGINX_VAR          "Yazid"</span>
</code></pre></div></div>

<h3 id="15-é‡æ–°ç¼–è¯‘">1.5 é‡æ–°ç¼–è¯‘</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#ç¼–è¯‘</span>
root@yazid-chen:/opt/nginx/nginx-1.11.4# make
<span class="c">#å®‰è£…</span>
root@yazid-chen:/opt/nginx/nginx-1.11.4# make <span class="nb">install</span>
<span class="c">#å¯åŠ¨</span>
root@yazid-chen:/opt/nginx/nginx-1.11.4# /usr/local/nginx/sbin/nginx
</code></pre></div></div>

<h3 id="16-éšè—åçŠ¶æ€">1.6 éšè—åçŠ¶æ€</h3>

<p><img src="https://i.imgur.com/PLrHNMX.png" alt="" /></p>

<p><img src="https://i.imgur.com/xGhn3vE.png" alt="" /></p>

<h2 id="äºŒç»™nginxä»¥æ™®é€šç”¨æˆ·è¿è¡Œçš„æƒé™">äºŒã€ç»™Nginxä»¥æ™®é€šç”¨æˆ·è¿è¡Œçš„æƒé™</h2>

<p>nginxæœåŠ¡é»˜è®¤å¯åŠ¨ç”¨æˆ·æ˜¯nobody</p>

<p><img src="http://i.imgur.com/lhzo8nw.png" alt="" /></p>

<p><strong>1)</strong> å»ºç«‹nginxç”¨æˆ·</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#ç”¨æˆ·ç¦æ­¢ç™»å½•ï¼Œä¸”æ— å®¶ç›®å½•</span>
useradd nginx <span class="nt">-s</span> /sbin/nologin <span class="nt">-M</span>
</code></pre></div></div>

<p>ä½¿ç”¨idæŸ¥çœ‹ç”¨æˆ·ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">id </span>nginx
</code></pre></div></div>

<p><strong>2)</strong> ä¿®æ”¹nginx.conf</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user  nobody<span class="p">;</span>
<span class="c"># å°†ä¸Šå¥ä¿®æ”¹ä¸º</span>
user  nginx<span class="p">;</span>
</code></pre></div></div>

<p><img src="http://i.imgur.com/8KL0RsH.png" alt="" /></p>

<p><strong>3)</strong> ç»™å…³é”®ç›®å½•æ™®é€šç”¨æˆ·åŠç»„æƒé™</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chown</span> <span class="nt">-R</span> nginx conf/ logs/ sbin/
<span class="nb">chgrp</span> <span class="nt">-R</span> nginx conf/ logs/ sbin/
</code></pre></div></div>

<p><strong>4)</strong> æ™®é€šç”¨æˆ·ä¸èƒ½é€šè¿‡bindå‡½æ•°ç»‘å®šå°äº1024çš„ç«¯å£,è€Œrootç”¨æˆ·å¯ä»¥åšåˆ°,<code class="highlighter-rouge">CAP_NET_BIND_SERVICE</code>çš„ä½œç”¨å°±æ˜¯è®©æ™®é€šç”¨æˆ·ä¹Ÿå¯ä»¥ç»‘ç«¯å£åˆ°1024ä»¥ä¸‹çš„ç«¯å£ã€‚è®©æ™®é€šç”¨æˆ·å¯åŠ¨nginxç»‘å®šåœ¨80ç«¯å£ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>setcap <span class="nv">CAP_NET_BIND_SERVICE</span><span class="o">=</span>+ep /usr/local/nginx/sbin/nginx
</code></pre></div></div>

<p><code class="highlighter-rouge">setcap</code>æ¥æºäº<code class="highlighter-rouge">Capabilities</code>ï¼ˆèƒ½åŠ›ï¼‰ï¼Œå®ƒæ‰“ç ´äº†UNIX/LINUXæ“ä½œç³»ç»Ÿä¸­è¶…çº§ç”¨æˆ·/æ™®é€šç”¨æˆ·çš„æ¦‚å¿µ,ç”±æ™®é€šç”¨æˆ·ä¹Ÿå¯ä»¥åšåªæœ‰è¶…çº§ç”¨æˆ·å¯ä»¥å®Œæˆçš„å·¥ä½œã€‚<code class="highlighter-rouge">setcap</code>å¯ä»¥è®¾ç½®ç¨‹åºæ–‡ä»¶çš„èƒ½åŠ›ã€‚å¦è¿˜æœ‰<code class="highlighter-rouge">getcap</code>å¯ä»¥è·å¾—ç¨‹åºæ–‡ä»¶æ‰€å…·æœ‰çš„èƒ½åŠ›ï¼Œ<code class="highlighter-rouge">getpcaps</code>å¯ä»¥è·å¾—è¿›ç¨‹æ‰€å…·æœ‰çš„èƒ½åŠ›ã€‚</p>

<p><strong>5)</strong> ä½¿ç”¨érootç”¨æˆ·è¿è¡Œï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> <span class="nt">-u</span> nginx /usr/local/nginx/sbin/nginx <span class="nt">-c</span> /opt/nginx/nginx-1.11.4/conf/nginx.conf 

</code></pre></div></div>

<p><strong>6)</strong> æ ¡éªŒå¯åŠ¨ç”¨æˆ·</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ps <span class="nt">-aux</span> |grep nginx
</code></pre></div></div>

<p><img src="http://i.imgur.com/5lthdxb.png" alt="" /></p>

<h2 id="ä¸‰ç¦ç”¨éå¿…è¦çš„æ–¹æ³•">ä¸‰ã€ç¦ç”¨éå¿…è¦çš„æ–¹æ³•</h2>

<p>é’ˆå¯¹<code class="highlighter-rouge">GET</code>ã€<code class="highlighter-rouge">POST</code>ä»¥åŠ<code class="highlighter-rouge">HEAD</code>ä¹‹å¤–çš„è¯·æ±‚ï¼Œå¦‚<code class="highlighter-rouge">PATCH</code>ã€<code class="highlighter-rouge">TRACE</code>ç­‰ï¼Œç›´æ¥è¿”å›äº†<code class="highlighter-rouge">444</code>çŠ¶æ€ç ï¼ˆ<code class="highlighter-rouge">444</code>æ˜¯Nginxå®šä¹‰çš„å“åº”çŠ¶æ€ç ï¼Œä¼šç«‹å³æ–­å¼€è¿æ¥ï¼Œæ²¡æœ‰å“åº”æ­£æ–‡ï¼‰ã€‚</p>

<p>å…·ä½“é…ç½®æ˜¯è¿™æ ·çš„,åœ¨<code class="highlighter-rouge">nginx.conf</code>çš„<code class="highlighter-rouge">Server</code>ä¸­åŠ å…¥ä»¥ä¸‹ä»£ç æ®µï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="nv">$request_method</span> <span class="o">!</span>~ ^<span class="o">(</span>GET|HEAD|POST<span class="o">)</span><span class="nv">$ </span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return    </span>444<span class="p">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å¯ç”¨chromeæµ‹è¯•ï¼Œåœ¨nginxçš„æ—¥å¿—<code class="highlighter-rouge">access.log</code>ä¸­çœ‹åˆ°æ•ˆæœã€‚</p>

<h2 id="å››å›¾ç‰‡é˜²ç›—é“¾æœªæµ‹è¯•">å››ã€å›¾ç‰‡é˜²ç›—é“¾ï¼ˆæœªæµ‹è¯•ï¼‰</h2>

<p>é…ç½®<code class="highlighter-rouge">nginx.conf</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>location ~ .<span class="k">*</span><span class="se">\.</span><span class="o">(</span>gif|jpg|jpeg|png|bmp|swf<span class="o">)</span><span class="nv">$ </span>
<span class="o">{</span> 
valid_referers none blocked <span class="k">*</span>.epinv.com epinv.com <span class="k">*</span>.qq.com <span class="k">*</span>.baidu.com<span class="p">;</span> 
<span class="k">if</span> <span class="o">(</span><span class="nv">$invalid_referer</span><span class="o">)</span> <span class="o">{</span> 
  rewrite ^/ http://www.epinv.com/epinv.png<span class="p">;</span> 
  <span class="c">#return 404; </span>
<span class="o">}</span> 
expires      30d<span class="p">;</span> 
<span class="o">}</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#è¯­æ³•</span>
valid_referers none | blocked | server_names | string ...<span class="p">;</span>
</code></pre></div></div>

<p>æŒ‡å®šåˆæ³•çš„æ¥æº<code class="highlighter-rouge">referer</code>ï¼Œä»–å†³å®šäº†å†…ç½®å˜é‡<code class="highlighter-rouge">$invalid_referer</code>çš„å€¼ï¼Œå¦‚æœ<code class="highlighter-rouge">referer</code>å¤´éƒ¨åŒ…å«åœ¨è¿™ä¸ªåˆæ³•ç½‘å€é‡Œé¢ï¼Œè¿™ä¸ªå˜é‡è¢«è®¾ç½®ä¸º0ï¼Œå¦åˆ™è®¾ç½®ä¸º1ã€‚ä¸åŒºåˆ†å¤§å°å†™çš„ã€‚</p>

<p><strong>å‚æ•°è¯´æ˜ï¼š</strong></p>

<ul>
  <li><code class="highlighter-rouge">none</code>: 				â€œRefererâ€ æ¥æºå¤´éƒ¨ä¸ºç©ºçš„æƒ…å†µã€‚</li>
  <li><code class="highlighter-rouge">blocked</code>: 			â€œRefererâ€æ¥æºå¤´éƒ¨ä¸ä¸ºç©ºï¼Œä½†æ˜¯é‡Œé¢çš„å€¼è¢«ä»£ç†æˆ–è€…é˜²ç«å¢™åˆ é™¤äº†ï¼Œè¿™äº›å€¼éƒ½ä¸ä»¥http://æˆ–è€…https://å¼€å¤´ã€‚</li>
  <li><code class="highlighter-rouge">server_names</code>: 		â€œRefererâ€æ¥æºå¤´éƒ¨åŒ…å«å½“å‰çš„server_namesï¼ˆå½“å‰åŸŸåï¼‰ã€‚</li>
  <li><code class="highlighter-rouge">arbitrary string</code>: 	ä»»æ„å­—ç¬¦ä¸²,å®šä¹‰æœåŠ¡å™¨åæˆ–è€…å¯é€‰çš„URIå‰ç¼€.ä¸»æœºåå¯ä»¥ä½¿ç”¨*å¼€å¤´æˆ–è€…ç»“å°¾ï¼Œåœ¨æ£€æµ‹æ¥æºå¤´éƒ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ¥æºåŸŸåä¸­çš„ä¸»æœºç«¯å£å°†ä¼šè¢«å¿½ç•¥æ‰ã€‚</li>
  <li><code class="highlighter-rouge">regular expression</code>: æ­£åˆ™è¡¨è¾¾å¼ï¼Œ<code class="highlighter-rouge">~</code>è¡¨ç¤ºæ’é™¤https://æˆ–http://å¼€å¤´çš„å­—ç¬¦ä¸²ã€‚</li>
</ul>

<p><strong>ç‰¹åˆ«è¯´æ˜ï¼š</strong>é˜²ç›—é“¾è·³è½¬çš„åœ°å€ï¼Œä¸èƒ½å†æ˜¯è®¾ç½®é˜²ç›—é“¾çš„è™šæ‹Ÿä¸»æœºåœ°å€ï¼Œè¦ç”¨ç¬¬ä¸‰ä¸ªè™šæ‹Ÿä¸»æœºï¼Œè¦ä¸å°±æˆæ­»å¾ªç¯äº†ï¼</p>

<h2 id="äº”é™åˆ¶è¿æ¥è¯·æ±‚æ•°æœªæµ‹è¯•">äº”ã€é™åˆ¶è¿æ¥è¯·æ±‚æ•°ï¼ˆæœªæµ‹è¯•ï¼‰</h2>

<p><code class="highlighter-rouge">ngx_http_limit_conn_module</code> å¯ä»¥é™åˆ¶å•ä¸ªIPçš„è¿æ¥æ•°ï¼Œ<code class="highlighter-rouge">ngx_http_limit_req_module</code> å¯ä»¥é™åˆ¶å•ä¸ªIPæ¯ç§’è¯·æ±‚æ•°ï¼Œé€šè¿‡é™åˆ¶è¿æ¥æ•°å’Œè¯·æ±‚æ•°èƒ½ç›¸å¯¹æœ‰æ•ˆçš„é˜²å¾¡CCæ”»å‡»ã€‚</p>

<h3 id="51-é™åˆ¶æ¯ç§’è¯·æ±‚æ•°">5.1 é™åˆ¶æ¯ç§’è¯·æ±‚æ•°</h3>

<p><code class="highlighter-rouge">ngx_http_limit_req_module</code>æ¨¡å—é€šè¿‡æ¼æ¡¶åŸç†æ¥é™åˆ¶å•ä½æ—¶é—´å†…çš„è¯·æ±‚æ•°ï¼Œä¸€æ—¦å•ä½æ—¶é—´å†…è¯·æ±‚æ•°è¶…è¿‡é™åˆ¶ï¼Œå°±ä¼šè¿”å›503é”™è¯¯ã€‚é…ç½®éœ€è¦åœ¨ä¸¤ä¸ªåœ°æ–¹è®¾ç½®ï¼š</p>

<ul>
  <li>nginx.confçš„httpæ®µå†…å®šä¹‰è§¦å‘æ¡ä»¶ï¼Œå¯ä»¥æœ‰å¤šä¸ªæ¡ä»¶ã€‚</li>
  <li>åœ¨locationå†…å®šä¹‰è¾¾åˆ°è§¦å‘æ¡ä»¶æ—¶nginxæ‰€è¦æ‰§è¡Œçš„åŠ¨ä½œã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http <span class="o">{</span>
    limit_req_zone <span class="nv">$binary_remote_addr</span> <span class="nv">zone</span><span class="o">=</span>one:10m <span class="nv">rate</span><span class="o">=</span>10r/s<span class="p">;</span>//è§¦å‘æ¡ä»¶ï¼Œæ‰€æœ‰è®¿é—®ipé™åˆ¶æ¯ç§’10ä¸ªè¯·æ±‚
    ...
    server <span class="o">{</span>
        ...
        location /search/ <span class="o">{</span>
            limit_req <span class="nv">zone</span><span class="o">=</span>one <span class="nv">burst</span><span class="o">=</span>5<span class="p">;</span>
        <span class="o">}</span>
</code></pre></div></div>

<p><strong>å‚æ•°è¯´æ˜ï¼š</strong></p>

<ul>
  <li><code class="highlighter-rouge">$binary_remote_addr</code>ï¼š  	äºŒè¿›åˆ¶è¿œç¨‹åœ°å€</li>
  <li><code class="highlighter-rouge">zone=one:10m</code>ï¼š    		å®šä¹‰zoneåå­—å«oneï¼Œå¹¶ä¸ºè¿™ä¸ªzoneåˆ†é…10Må†…å­˜ï¼Œç”¨æ¥å­˜å‚¨ä¼šè¯ï¼ˆäºŒè¿›åˆ¶è¿œç¨‹åœ°å€ï¼‰ï¼Œ1må†…å­˜å¯ä»¥ä¿å­˜16000ä¼šè¯</li>
  <li><code class="highlighter-rouge">rate=10r/s</code>ï¼š     		é™åˆ¶é¢‘ç‡ä¸ºæ¯ç§’10ä¸ªè¯·æ±‚</li>
  <li><code class="highlighter-rouge">burst=5</code>ï¼š         		å…è®¸è¶…è¿‡é¢‘ç‡é™åˆ¶çš„è¯·æ±‚æ•°ä¸å¤šäº5ä¸ªï¼Œå‡è®¾1ã€2ã€3ã€4ç§’è¯·æ±‚ä¸ºæ¯ç§’9ä¸ªï¼Œé‚£ä¹ˆç¬¬5ç§’å†…è¯·æ±‚15ä¸ªæ˜¯å…è®¸çš„ï¼›åä¹‹ï¼Œå¦‚æœç¬¬ä¸€ç§’å†…è¯·æ±‚15ä¸ªï¼Œä¼šå°†5ä¸ªè¯·æ±‚æ”¾åˆ°ç¬¬äºŒç§’ï¼Œç¬¬äºŒç§’å†…è¶…è¿‡10çš„è¯·æ±‚ç›´æ¥503ï¼Œç±»ä¼¼å¤šç§’å†…å¹³å‡é€Ÿç‡é™åˆ¶ã€‚</li>
  <li><code class="highlighter-rouge">nodelay</code>ï¼š         		è¶…è¿‡çš„è¯·æ±‚ä¸è¢«å»¶è¿Ÿå¤„ç†ï¼Œè®¾ç½®å15ä¸ªè¯·æ±‚åœ¨1ç§’å†…å¤„ç†ã€‚</li>
</ul>

<h3 id="52-é™åˆ¶ipè¿æ¥æ•°">5.2 é™åˆ¶IPè¿æ¥æ•°</h3>

<p>è®¾ç½®å…±äº«å†…å­˜åŒº,æœ€å¤§å…è®¸è¿æ¥æ•°å¯¹åº”ä¸€ä¸ªç»™å®šçš„é”®å€¼ã€‚å½“è¶…è¿‡è¿™ä¸ªæé™æ—¶,æœåŠ¡å™¨å°†è¿”å›503é”™è¯¯(æœåŠ¡æš‚æ—¶ä¸å¯ç”¨)åœ¨å›å¤ä¸€ä¸ªè¯·æ±‚:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http <span class="o">{</span>
    limit_conn_zone <span class="nv">$binary_remote_addr</span> <span class="nv">zone</span><span class="o">=</span>addr:10m<span class="p">;</span>
    ...
    server <span class="o">{</span>
        ...
        location /download/ <span class="o">{</span>
            limit_conn addr 1<span class="p">;</span>
        <span class="o">}</span>
</code></pre></div></div>

<p>ä»¥ä¸Šæ¯ä¸ªIPåªå…è®¸1ä¸ªè¿æ¥ã€‚</p>

<p>ä¸‹é¢çš„é…ç½®å°†ä¼šé™åˆ¶å®¢æˆ·ç«¯IPè¿æ¥åˆ°nginxæœåŠ¡å™¨çš„æ•°é‡ï¼Œä»¥åŠä¸æ­¤åŒæ—¶nginxæœåŠ¡å™¨åˆ†å‘åˆ°è™šæ‹ŸæœåŠ¡å™¨çš„æ€»æ•°ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http <span class="o">{</span>
limit_conn_zone <span class="nv">$binary_remote_addr</span> <span class="nv">zone</span><span class="o">=</span>perip:10m<span class="p">;</span>
limit_conn_zone <span class="nv">$server_name</span> <span class="nv">zone</span><span class="o">=</span>perserver:10m<span class="p">;</span>
...
server <span class="o">{</span>
    ...
    limit_conn perip 10<span class="p">;</span>
    limit_conn perserver 100<span class="p">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è®¾ç½®å…±äº«å†…å­˜åŒºï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#æŒ‡ä»¤</span>
limit_conn_zone key <span class="nv">zone</span><span class="o">=</span>name:size<span class="p">;</span>
<span class="c">#é»˜è®¤</span>
limit_conn_zone <span class="nv">$binary_remote_addr</span> <span class="nv">zone</span><span class="o">=</span>addr:10m<span class="p">;</span>
</code></pre></div></div>

<p>å½“è®¾ç½®äº†æœåŠ¡å™¨è¿æ¥æ•°é™åˆ¶çš„æƒ…å†µä¸‹çš„æ—¥å¿—ç­‰çº§é…ç½®ï¼Œé»˜è®¤errorï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#æŒ‡ä»¤</span>
limit_conn_log_level info | notice | warn | error<span class="p">;</span>

<span class="c">#é»˜è®¤</span>
limit_conn_log_level error<span class="p">;</span>
</code></pre></div></div>

<p>è®¾ç½®æ‹’ç»è¯·æ±‚æ—¶è¿”å›çš„çŠ¶æ€ç ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#æŒ‡ä»¤</span>
limit_conn_status code<span class="p">;</span>
<span class="c">#é»˜è®¤</span>
limit_conn_status 503<span class="p">;</span>
</code></pre></div></div>

<h3 id="53-ç™½åå•è®¾ç½®">5.3 ç™½åå•è®¾ç½®</h3>

<p><code class="highlighter-rouge">http_limit_conn</code>å’Œ<code class="highlighter-rouge">http_limit_req</code>æ¨¡å—é™åˆ¶äº†å•ipå•ä½æ—¶é—´å†…çš„å¹¶å‘å’Œè¯·æ±‚æ•°ï¼Œä½†æ˜¯å¦‚æœNginxå‰é¢æœ‰è´Ÿè½½å‡è¡¡æˆ–è€…åå‘ä»£ç†ï¼Œnginxè·å–çš„éƒ½æ˜¯æ¥è‡ªè´Ÿè½½å‡è¡¡çš„è¿æ¥æˆ–è¯·æ±‚ï¼Œè¿™æ—¶ä¸åº”è¯¥é™åˆ¶è´Ÿè½½å‡è¡¡çš„è¿æ¥å’Œè¯·æ±‚ï¼Œå°±éœ€è¦<code class="highlighter-rouge">geo</code>å’Œ<code class="highlighter-rouge">map</code>æ¨¡å—è®¾ç½®ç™½åå•ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>geo <span class="nv">$whiteiplist</span>  <span class="o">{</span>
        default 1<span class="p">;</span>
        10.11.18.120 0<span class="p">;</span>
    <span class="o">}</span>
map <span class="nv">$whiteiplist</span>  <span class="nv">$limit</span> <span class="o">{</span>
        1 <span class="nv">$binary_remote_addr</span><span class="p">;</span>
        0 <span class="s2">""</span><span class="p">;</span>
    <span class="o">}</span>
limit_req_zone <span class="nv">$limit</span> <span class="nv">zone</span><span class="o">=</span>one:10m <span class="nv">rate</span><span class="o">=</span>10r/s<span class="p">;</span>
limit_conn_zone <span class="nv">$limit</span> <span class="nv">zone</span><span class="o">=</span>addr:10m<span class="p">;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">geo</code>æ¨¡å—å®šä¹‰äº†ä¸€ä¸ªé»˜è®¤å€¼æ˜¯1çš„å˜é‡<code class="highlighter-rouge">whiteiplist</code>,å¹¶åŠ å…¥ç™½åå•IPï¼Œå…¶å˜é‡<code class="highlighter-rouge">whiteiplist</code>çš„å€¼ä¸º0ã€‚</p>

<p><code class="highlighter-rouge">whiteiplist</code>çš„å€¼å¯¹åº”ç€<code class="highlighter-rouge">map</code>æ¨¡å—ã€‚1åˆ™å—é™ï¼Œ0åˆ™ä¸å—é™ã€‚</p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<p><a href="http://www.bkjia.com/Linux/1124560.html">Nginxå®‰å…¨ä¼˜åŒ–ä¹‹éšè—ç‰ˆæœ¬å·</a></p>

<p><a href="https://imququ.com/post/my-nginx-conf-for-security.html#simple_thread">æœ¬åšå®¢ Nginx é…ç½®ä¹‹å®‰å…¨ç¯‡</a></p>

<p><a href="http://nginx.org/en/docs/">nginx documentation</a></p>

:ET